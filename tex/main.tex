%% Author_tex.tex
%% V1.0
%% 2012/13/12
%% developed by Techset
%%
%% This file describes the coding for rsproca.cls

\documentclass[openacc]{rsproca_new}%%%%where rsproca is the template name

%%%% *** Do not adjust lengths that control margins, column widths, etc. ***

%%%%%%%%%%% Defining Enunciations  %%%%%%%%%%%
\newtheorem{theorem}{\bf Theorem}[section]
\newtheorem{condition}{\bf Condition}[section]
\newtheorem{corollary}{\bf Corollary}[section]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\newcommand{\neg}{NULL^{-}}

%ADD situations where we need the more complex graph to explain what's going on.

\renewcommand{\neg}[1]{^{-}#1}

% Created 2018-08-06 Mon 17:55
% Intended LaTeX compiler: pdflatex

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{grffile}
\usepackage{longtable}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{textcomp}
\usepackage{amssymb}
\usepackage{capt-of}
\author{Joshua Kaminsky}
\date{\today}
\title{}
\begin{document}

%%%% Article title to be placed here
\title{Single-World Counterfactual Inference}

\author{%%%% Author details
Joshua Kaminsky$^{1}$, Lindsay T. Keegan$^{1}$,\\C. Jessica E. Metcalf$^{12}$ and Justin Lessler$^{1}$}

%%%%%%%%% Insert author address here
\address{$^{1}$Department of Epidemiology, Johns Hopkins Bloomberg School of Public Health, Baltimore, MD, USA\\
$^{2}$Department of Ecology and Evolutionary Biology, Princeton University, Princeton, NJ, USA}

%%%% Subject entries to be placed here %%%%
\subject{Epidemiology, Infectious Disease Modeling}

%%%% Keyword entries to be placed here %%%%
\keywords{Counterfactuals, Infectious disease modeling, Infectious disease Dynamics, Network Modeling}

%%%% Insert corresponding author and its email address}
\corres{Justin Lessler\\
\email{justin@jhu.edu}}

%%%% Abstract text to be placed here %%%%%%%%%%%%
% Recount words
\begin{abstract} % 154 words MAX 183 words
  Determining the effects of an intervention on a disease outbkreak is an important problem in epidemiology.
  However, multiple confounders and sources of noise make it difficult to address. %23 words
  Here we present a method that addresses an important source of noise, stochastic variation within the same population. %21 words
  This allows for improved ability to select the best interventions for an outbreak
  Our method, like many others, employs compartmental models and extends an individual-level effect of the intervention to the population-level effect. %20 words
  We eliminate stochastic variation between epidemics by tracking both what happens with intervention and what happens without intervention within a single simulated epidemic. %24 words
  To simultaneously keep track of both states, we store all transition states that are possible either with or without the intervention on a network. %21 words
  We can actualize this network to recover the events that occur both with and without the intervention. %
  We demonstrate our method on an influenza epidemic and compare the results of our method to an existing method.
  We compare across three interventions: handwashing, vaccination, antivirals, and a control; and evaluate performance on the final size estimate.
  We find that our method reduces the variance of all estimates, and in one case makes the results statistically significant. %25 words
  Although our method is more computationally intensive than traditional methods, it is still computationally tractable for many common use cases, making it a useful tool for selecting interventions. %17 words
\end{abstract}
%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%% End of first page %%%%%%%%%%%%%%%%%%%%%

\maketitle


\section{Introduction}
Determining how to intervene in the face of an outbreak is a fundamental question in epidemiology.
Dynamical models are one of the main tools for assessing the impact of an intervention or selecting which intervention to employ, as they provide a cost effective, timely approach to acurately evaluate interventions.
Generally, stochastic models are used to represent both the disease process and the intervention.
This allows us to evaluate the effects of an intervention in a theoretical capacity to provide insight into how to respond to an actual epidemic.
Often these modeling approaches provide the best evidence-based estimates as randomized controlled trials or population-level causal inference are not feasible.

% Awkward
Determining the effect of an intervention is fundamentally a counterfactual question: if one did intervene on this population during this epidemic, how would the quantity of interest be different than if they had not intervened on that same population during the same epidemic.
In reality, it is impossible to have information on the results of both intervening and not intervening for the same population during the same epidemic.
This is known as the fundamental problem in causal inference.\cite{holland:1986}

Although in an actual epidemic the fundamental problem of causal inference holds, it is not necessary or desirable to replicate this in a model. 
However, many existing methods retain this problem, running separate simulations for interventions and non-interventions.
We refer to this type of method as multiple-world inference.
% Our proposed method avoids this pitfall, running running both the intervention and non-intervention in the same simulation.

A number of recent studies use multiple-world inference to determine the effectiveness of interventions.
For example, Lessler et al. used multiple-world inference to examine the effects of different ways to trigger Measles vaccination campaigns in Africa. They noted multiple-world inference as a limitation \cite{lessler-et-al:2016}.
Longini et al. also used multiple-world inference in their assessment of controlling pandemic influenza \cite{longini-et-al:2005}.
In 2014, Rivers et al. used multiple-world inference to determine the impact of interventions against Ebola, including at least one intervention whose confidence interval overlapped the baseline \cite{rivers-et-al:2014}.
These are only a few of many published examples, and we assume there are other, unpublished examples where statistical power was not high enough for significant results.
Multiple-world inference often has problems with low statistical power, and only the cases where power is sufficient are published.

Here, we describe an alternative to multiple-world inference, which we call single-world inference.
Our method avoids running both intervention and non-intervention in a single simulation.  [
Single-world inference is an adaptation of a contact-network epidemiological method called percolation \cite{miller-book}.
In percolation, disease transmission is represented as a network whose nodes represent people and whose edges represent transmission.
The percolation method starts with a graph of all possible transmissions, then removes transmissions that are either impossible, or are possible but do not actually occur according to the stochastic model.
Any edges that remain transmit disease.

Single-world inference expands on traditional percolation in two important ways.
First, we explicitly model time, letting nodes represent people at specific times.
As part of explicitly modeling time, we also directly model state changes rather than only considering infectious pairs.
Second, we allow our model to include an intervention.
This means we deal with the possible state of nodes instead of their actual states.
Consequently, fewer transitions are impossible and we need to test more as part the method.

Previous work has applied single-world inference methods for specific interventions, including targeting vaccinations, without defining a generalizable methodology that could be applied to other interventions \cite{kenah-miller:2011}.
Kenah and Miller 2011 apply a single-world inference method to determine the impact of vaccinating different individuals within a network \cite{kenah-miller:2011}.
They are able to obtain direct estimates for the effect of different vaccination strategies within the context of a single epidemic, because they first percolate the network then intervene (i.e. vaccinate).

%FIX ME awkward
In this paper, we develop the single-world method using influenza as a guiding example.
We then generalize the method to a large class of compartmental models and interventions.
Finally, we compare our method to the multiple-world method in the context of three interventions and a control on final size in influenza.

\section{Methods}

For this paper, we restrict our description to compartmental models. 
While single-world inference methods can be applied to a larger class of epidemiological models, these extensions are beyond the scope of this paper.
Compartmental models consist of classes (or compartments) of people and describe the transitions between the different compartments.
There are many variations on compartmental models, but we focus on models where the transitions are stochastic, as deterministic models fundamentally ignore the problem of model variance.
Further, while compartmental models generally describe population-level events, they can also be at the individual-level.
Most population-level models can be adapted to be written as individual-level models.
In this paper, we use individual-level compartmental models since as the only information we have on the intervention is at the individual-level.

\subsection{Example: Influenza}

For our influenza example, we employ a standard SIR compartmental model, where individuals are either susceptible, infected, or removed.
By modeling influenza transmission within a single season we do not need to account for loss of immunity, thus, we chose an SIR model (rather than an SIS model). 
Additionally, by only modeling the outcomes of a single season, we assume births and deaths are negligible and do not include them. %Come back to this.
People become infected at a rate $\beta = 0.78$ per day and are removed at a rate $\gamma = 0.44$ per day \cite{forsberg-white-et-al:2009}.
In the individual-level framework, $\beta$ represents the probability of infectious contact between any particular infected-susceptible pair and $\gamma$ represents the probability of recovery of an infected individual at each time step. %Convert this to conditional probabilities maybe.

\begin{figure}{Table 1}\label{fig:performance}
\begin{tabular}{|l|l|l|}
  \hline
  Task & Space Use & Time / simulation\\\hline
  Unpruned Network & $58.4$ TB & forever \\\hline
  Prune Network & $1.73$ GB & 54 seconds \\\hline
  Realize Intervention& $1.3-1.4$ KB & $16-20$ seconds \\\hline
  Multiple-World Inference& $2.6-2.8$ KB & ??? \\\hline
\end{tabular}
\caption{Parameters for the SIR model.}
\end{figure}



% \begin{figure}\label{fig:network-example}
% \includegraphics[width=\textwidth]{../figures/figure1} %Probably turn the coloration into a legend.
% \caption{A visual representation of the complete graph.  \textbf{a)} Shows an example of all infection and recovery events that can occur in a population of $3$ people over time.  \textbf{b)} shows the The upper panels show the way we represent \textbf{a)} infectious contacts colored red and \textbf{b)} recoveries colored green.  Both of these include references to the intervention, colored blue and the initial conditions, colored in purple.  \textbf{c)} shows a complete graph on two people for two time points.  Even for only two people and two time steps, this graph is visually quite complicated, and we have found that it is easier to simplify the graph as in \textbf{d)} using colored edges to denote the patterns of nodes.}
% \end{figure}
% 
\begin{figure}\label{fig:pruning}
\includegraphics[width=\textwidth]{../figures/figure6} %Probably turn the coloration into a legend.
\caption{Diagram demonstrating pruning. \textbf{a)}--\textbf{i)} show an example of pruning.  The first column represents updating possible initial values.  The second column represents removing impossible events without testing them.  The third column represents testing the remaining edges to determine which actually occur.  In the final row, \textbf{j)} represents the results of the epidemic with the intervention, while \textbf{k)} reprents the results of the same epidemic without the intervention.  This example also shows how an epidemic which only prevents cases can actually cause new cases to occur.}
\end{figure}

We present four example interventions: hand-washing, vaccination, antivirals, and null (control) interventions.
We choose these examples to highlight the different ways interventions can interact with single-world inference.
We show how each intervention affects the SIR model, and the specific parameters we use to represent the intervention.
We go on to present a general intervention framework in section \ref{sec:general}.

For our hand-washing intervention, we assume that everyone washes their hands and that hand washing reduces the transmissibility by $1\%$.
For our vaccination intervetnion, we choose $25\%$ of people to be vaccinated at the beginning of the year, and vaccination fully protects $33\%$ of vaccinated indiviuals.
For our antiviral intervention, we choose $25\%$ of people to take antivirals when they first become infected, which reduce their average time infected by $.7$ days \cite{}.
We model this as an additional $36.1\%$ chance to recover at each time step.
For our null intervention, we do nothing.
While this is not a true intervention, it is effective at highlighting the differences between single-world and multiple-world inference.
We compare single-world and multiple-world inference by running $1000$ simulations of each type on a population of $4,000$ for $100$ days and calculating the estimated number of cases averted.

Now that we have our SIR model and modifications for the interventions, we can develop single-world inference.
We start with a network with a node for each person-time.
Each node might possibly be susceptible, infected, or recovered.
We will have two types of edges: one for infectious contacts, and one for recoveries.
At each time, each person will have a recovery edge connecting them to themselves one time step in the future.
At each time, each person will have an infectious contact edge connecting them to each other person at one time step in the future.
We call this network the complete network.

%FIX ME This shouldn't be the first tiem pruning is mentioned.
Pruning the network happens in three steps, repeated for each time.
First, we update the nodes based on what we know from all previous times.
Second, we remove edges that we know to be impossible (e.g. a person cannot recover if they could not have been infected).
Third, we test the remaining edges based on the SIR model to see which actually would occur and which would not.
We now go into more detail about each of the steps (Figure \ref{fig:pruning}).

When we originally built the network, we said each node could be susceptible, infected, or recovered.
However, we often can eliminate one or more states as impossible.
We know the initial state of each person, so the node representing that person at time $0$ must be that, and cannot be any of the other states.
Since none of our interventions cause infection, we assume that anyone who could not have been infected at the previous time, and did not get infected since then is still not infected.
Since none of our interventions prevent recovery, we assume that anyone who recovered since the previous time, and did not get infected since the previous time is not currently infected.

With this information about the current state of the nodes, we can see that certain types of edges are impossible.
For infectious contacts, we can rule out any edge where either the infector cannot be infected, or the infectee cannot be susceptible.
For recoveries, we can rule out any edge where the person cannot be infected.

For the edges that remain, we randomly keep or remove them according to our SIR model.
We keep infectious contacts with probability $\beta$.
We keep recoveries with probability $\gamma$.
These edges we keep will happen if the actual states of the nodes they depend on match their conditions, and the intervention doesn't change anything.
We call this network the pruned network.

Now that we have this pruned network, applying our intervention is fairly straightforward.
We do exactly the same pruning procedure with one difference.
Now when we update the states of the nodes, we are updating their actual state instead of their possible states.
We can then read all of the events that actually happened from the graph, and use those events to recover, for example, the final size of the epidemic.

Notice, too, that the intervention is applied after all of SIR model has played out.
Moreover, as long as we have the pruned graph, we can use it again on a different intervention.
By comparing the final size of in the intervention case to the final size in the null intervention case, we can extract the number of cases the intervention averted in the single epidemic represented by the pruned graph.

\subsection{General Framework}

The method described in the influenza example extends to a general class of compartmental models and interventions.
We outline the differences between a general model and the influenza example below.


We define a general compartmental model as a system of difference equations with $K$ compartments governed by \(\Delta x_{j} = \sum_{i \neq j} \alpha_{i,j}x_i + \sum_{i \neq j, k} \alpha_{i,j,k} x_ix_k\).
We can view $\alpha_{i,j}$ as the probability that a person transitions from state $j$ to state $i$, and $\alpha_{i,j,k}$ as the probability that a person transitions from state $j$ to state $i$ after interacting with an individual in state $k$.
Each transition is represented both as entering a compartment $\alpha > 0$, and leaving a compartment $\alpha < 0$.
We only are interested in people entering new states, and so we only keep track of positive $\alpha$.
We can rephrase our influenza example in these new terms by, $S=x_1$, $I=x_2$, $R=x_3$, $\beta = \alpha_{2,1,2}$, and $\gamma = \alpha_{3,2}$.

We construct the graph similarly to how we did before.
The nodes are the same, except now their possible states are $x_1 \dots x_K$.
For each $\alpha$, we have a different type of edge.
For $\alpha_{i,j,k}$ we connect each node to each other node at the next time with an edge of that type.
For $\alpha_{i,j}$ we connect each node the same person at the next time step with an edge of that type.
Unlike in the influenza example, there may be multiple edges connecting the same pair of nodes.

We prune the same way as before.
For each time step, we update the possible states, remove impossible edges, and test the remaining edges to see which would occur.
Our assumptions about the intervention, which allow us to prune more effectively, carry over.
We assume that our interventions do not add edges to the graph, unless those edges are to a new category or a terminal category (like recovered) and we assume that our interventions do not prevent any transitions governed by $\alpha_{i,j}$.
These assumptions are more restrictive in the general case than the SIR case.

% FIX ME tie up paragraph.
We then apply our intervention and extract the actual states in almost the same way, but need to deal with an additional circumstance.
It is now possible that two different events affect the same person at the same time, changing their state to two different states.
As an example, in an age cohort model, someone might be infected, and move to a higher age state at the same time.
There are many reasonable ways to handle this, and the right one depends on the model.
In the age case, the correct answer is that both events happen.
In a different case, the answer may be to choose randomly between the two events, or something even more complicated.

\section{Results}

\begin{figure}\label{fig:epicurve}
\centering
\includegraphics[width=.31\textwidth]{../figures/intervention-effects-raw-boxplots}
\includegraphics[width=.31\textwidth]{../figures/intervention-effects-combined-boxplots}
\includegraphics[width=.31\textwidth]{../figures/intervention-effects-time-series-susceptible.pdf}
\caption{\textbf{Left)} Boxplots of simulations results under the each intervention scenario.  Notice that all of the boxplots overlap, which implies that from the population perspective, the effects of the interventions are all insignificant.  \textbf{Right)} The single-world change in final size for each intervention scenario.  Unlike the right hand figure, very few of the boxplots overlap with The null intervention.}
\end{figure}

We demonstrate our method by applying it to controlling an influenza outbreak where we compare the number of cases averted by three different interventions: hand-washing, vaccination, and antiviral interventions.
We compare the outcomes of our method to that of the multiple-world inference method, the current standard way to simulate the effects of an intervention.
We find that single-world inference generally has the same point estimates as multiple-world inference, but has narrower confidence intervals.
We also see that multiple-world inference has some nonsensical results that single-world inference avoids.

For single-world inference, we found that every non-null intervention had a significant (p<.05) effect on final size: Null $ 0 $ (CI $ 0 $ \textemdash $ 0 $), Antivirals $ -819.125 $ (CI $ -2899.05 $ \textemdash $ -206 $), Social Distancing $ -153.594 $ (CI $ -298 $ \textemdash $ -12.975 $), Vaccination $ -284.955 $ (CI $ -437.075 $ \textemdash $ -130 $).
For multiple-world inference, we found that all but one non-null intervention had a significant (p<.05) effect on final size: Null $ 4.94 $ (CI $ -183.05 $ \textemdash $ 195.1 $), Antivirals $ -814.185 $ (CI $ -2913.05 $ \textemdash $ -176 $), Social Distancing $ -148.654 $ (CI $ -355.1 $ \textemdash $ 69.025 $), Vaccination $ -280.015 $ (CI $ -499.2 $ \textemdash $ -72 $).
In addition to the effects on final size, we observe that multiple-world has unintuitive effects on the shape of the epidemic (Figure \ref{epicurve}).

We released a software package, \texttt{counterfactual}, on \texttt{CRAN}, %NOTE: This is not true yet
which implements single-world inference as described in section \ref{sec:methods}.
It follows the assumptions and procedures outlined above, but does not enforce those assumptions, or deal with conflicting state changes.
The amount of space and time pruning takes in the software package is $\mathcal O(E)$, where $E[O(E)]$ which is on average $O(t(n^2\sum \alpha_{i,j,k} + n \sum\alpha_{i,j}))$ per simulation, or $O(t(n^2\beta + n\gamma))$ in the case of the SIR model.
The amount of time the interventions take is also $\mathcal O(E)$, but the constant is lower (Table \ref{table:performance}).
This shows us that the number of infectious compartments, the population, number of times, and number of simulations all impact the amount of time taken, but mostly population.

\section{Discussion}
In this paper, we present a single-world inference method that isolates the counterfactual comparison to reduce uncertainty in inference about interventions.
We demonstrate that our method ignores cross-epidemic variation, and in doing so avoids counterintuitive results.
Our method can be applied to a broad class of models and interventions, most of which are supported by our software package.
Our method is modular, allowing multiple interventions to be compared simultaneously.

Single-world inference answers a more precise question than multiple-world inference, but the general question is sometimes the right question to ask.
They ask, "If you were to see another epidemic in the same population, what would the impact of an intervention look like in that epidemic?"
For some problems, particularly those focused on a future epidemic, this question may be important in its own right.
For others, particularly those focused on an intervention and when to use it, our question may be more appropriate.

Additionally, our model does have some limitations.
Some reasonable interventions are out of reach as they do not follow the assumptions we make about interventions as part of pruning.
For a particular intervention, we can make stronger assumptions, even going so far as to run the intervention as we prune, keeping only the actual state as possible.
We think there may be a better middle ground, one that allows more interventions, and also improves performance.
It would be nice to be able to make probabilistic assumptions about the interventions, which would guarantee success with high probability.
Even with these changes, interventions that fundamentally change the way the disease behaves (changes the underlying model) are beyond the scope of this method.

Another set of limitations is that discrete time compartmental models are not cutting edge modeling techniques.
Our method is discrete time, but Gillespie algorithms would allow it to be extended into continuous time.
Our method considers compartmental models, but it could be extended to network or agent based models.
Our method also uses a fixed difference equation, a stronger limitation than we would like.
We can construct interventions to overcome this limitation to some extent, but it could be improved.
Moreover, to account for all of them would result in  combinatorial explosion and quickly become computationally intractable. % FIX ME: is this sentence actually true?

We present our method as a theoretical framework, but would like to see it applied to real world epidemic data.
It would be interesting to see if one could extract (possible) pruned graphs from epidemics, and use that information to address the question, "What would have happened?"

\enlargethispage{20pt}

\ethics{This research did not require ethics approval as it used simulated  data.}

\dataccess{Code used for the included analyses are available upon publication.}

\aucontribute{Conception and design of study: JL\\
Development and/or verification of analytic methods: JK and JL\\
Analysis and/or interpretation of results: JK, LTK, and JL\\
Drafting the manuscript: JK and LTK\\
Revising the manuscript: JK, LTK, CJM, and JL \\
Approval of the final manuscript: JK, LTK, CJM, and JL}

\competing{We have no competing interests.}

\funding{Insert funding text here.}

\ack{Insert acknowledgment text here.}



\bibliographystyle{apalike}
\bibliography{bibliography}
\end{document}


However, a graph like this is intractably large (for \(4000000\) people, \(3\) states, and \(365\) time points, it would take almost \(18\) pedabytes to store it).

If we are not concerned about interventions, we could also remove parts of the graph disconnected from the graph at time $0$, since they would never come up.

Then starting from our initial conditions, we can trace through the paths that actually occur to see the epidemic.

However, the amount of time the model spends running is not uniform: it takes $xx$ hours to set up the counterfactual, but only $xx$ to run the intervention.
\textbf{In the context of comparing interventions, this is a benefit since the set up need only be run a single time.} THIS IS DISCUSSION
