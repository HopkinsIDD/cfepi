---
output: revealjs::revealjs_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Counterfactual 
We want to simulate the effect of an intervention on an epidemic.  Other approaches simulate two epidemics: one with the intervention and one without.

We want to compare on the same epidemic.  We determine all of the possible state transmission events, and then use these to construct two epidemic curves.

We keep track of transmission events that would not be relevant, but might become relevant in case of an intervention.

## Model Setup

For testing, we did a simple SIR model with the following equations

\begin{align*}
   \textrm{d}S &= -IS \beta
\\ \textrm{d}I &= IS \beta - I \gamma
\\ \textrm{d}R &= I \gamma
\end{align*}

```{r,echo=FALSE}
init = c(S = 3990, I = 10, R = 0)
beta = c("beta"= .4/sum(init))
gamma = c("gamma" = .2)
transitions = matrix(0,3,3,dimnames= list(c("S","I","R"),c("S","I","R")))
interactions = array(0,c(3,3,3),dimnames = list(c("S","I","R"),c("S","I","R"),c("S","I","R")))
transitions[2,3] = gamma
interactions[1,2,2] = beta
tstart = 30
distancing_percentage = .01
```
For initial conditions, we took $S = `r init["S"]`$, $I = `r init["I"]`$ and $R = `r init["R"]`$.  
For the intervention, we said that any infectious contacts after time `r tstart`, had a `r distancing_percentage` chance not to occur.

```{r, echo=FALSE, message=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
input_dir <-
  "~/svn/counterfactual/branches/R_compliant/output/"
input_files <- list.files(input_dir)
no_intervention_0_files <-
  input_files[
    startsWith(
      input_files,
      "first_counterfactual.noint.0"
    )
  ]
no_intervention_1_files <-
  input_files[
    startsWith(
      input_files,
      "first_counterfactual.noint.1"
    )
  ]
intervention_0_files <-
  input_files[
    startsWith(
      input_files,
      "first_counterfactual.int.0"
    )
  ]

intervention_0_data <-
  bind_rows(
    lapply(
      paste(input_dir,intervention_0_files,sep='/'),
      function(fname){
        data <- read_csv(fname,col_names = FALSE)
        data <- data[,-ncol(data)]
        return(
          mutate(
            data,
            file = fname,
            t = 1:nrow(data)
          )
        )
      }
    )
  )
no_intervention_0_data <-
  bind_rows(
    lapply(
      paste(input_dir,no_intervention_0_files,sep='/'),
      function(fname){
        data <- read_csv(fname,col_names = FALSE)
        data <- data[,-ncol(data)]
        return(
          mutate(
            data,
            file = fname,
            t = 1:nrow(data)
          )
        )
      }
    )
  )
no_intervention_1_data <-
    bind_rows(
    lapply(
      paste(input_dir,no_intervention_1_files,sep='/'),
      function(fname){
        data <- read_csv(fname,col_names = FALSE)
        data <- data[,-ncol(data)]
        return(
          mutate(
            data,
            file = fname,
            t = 1:nrow(data)
          )
        )
      }
    )
  )
intervention_same <- intervention_0_data
intervention_different <- intervention_0_data
for(column in names(intervention_same)[startsWith(names(intervention_same),"X")]){
  intervention_same[[column]] =
    intervention_0_data[[column]] -
    no_intervention_0_data[[column]]
}
for(column in names(intervention_different)[startsWith(names(intervention_different),"X")]){
  intervention_different[[column]] =
    intervention_0_data[[column]] -
    no_intervention_1_data[[column]]
}
intervention_same <-
  filter(intervention_same,t<100)
intervention_different <-
  filter(intervention_different,t<100)
```

## Figure 1: Same Transmission
```{r,echo=FALSE}
ggplot(intervention_same,aes(x=t,group=file)) +
  # geom_line(aes(y=X1,col='S'),alpha=.1) +
  # geom_line(aes(y=X2,col='I'),alpha=.1) +
  geom_line(aes(y=X3,col='R'),alpha=.1)
```

## Figure 2: Different Transmission

```{r,echo=FALSE}
ggplot(intervention_different,aes(x=t,group=file)) +
  # geom_line(aes(y=X1,col='S'),alpha=.1) +
  # geom_line(aes(y=X2,col='I'),alpha=.1) +
  geom_line(aes(y=-X3,col='R'),alpha=.1)
```

## Observations
 - The same transmission case is less variable, (`r range(intervention_same$X3)`) vs (`r range(intervention_different$X3)`)
 - The probability of introducing more cases is much lower in the same transmission case `r mean(intervention_same$X3 > 0)` vs `r mean(intervention_different$X3 > 0)`
 - The effect before time `r tstart` is correct only in the same transmission case
 ```{r,echo=FALSE}
intervention_0_data %>%
  group_by(file) %>%
  summarize(peak_time = which.max(X2)) %>%
  ungroup() %>%
  select(-file) ->
  intervention_0_peak_time
no_intervention_0_data %>%
  group_by(file) %>%
  summarize(peak_time = which.max(X2)) %>%
  ungroup() %>%
  select(-file) ->
  no_intervention_0_peak_time
no_intervention_1_data %>%
  group_by(file) %>%
  summarize(peak_time = which.max(X2)) %>%
  ungroup() %>%
  select(-file) ->
  no_intervention_1_peak_time
same_peak_change <- (no_intervention_0_peak_time - intervention_0_peak_time)
different_peak_change <- no_intervention_1_peak_time - intervention_0_peak_time
```
 - The effect on peak time is more stable in the same transmission case (mean `r mean(same_peak_change[[1]])`, sd `r sd(same_peak_change[[1]])`) vs (mean `r mean(different_peak_change[[1]])`, sd `r sd(different_peak_change[[1]])`)

## Figure 3: Transmission Chain
```{r,engine="tikz",echo=FALSE,fig.ext='svg'}
\begin{tikzpicture}
\node[draw, fill = red!30, circle,radius=.1] (P1) at (4,0) {};

\node[draw, fill = red!30, circle] (P11) at (2,-2) {};
\node[draw, fill = red!30, circle] (P12) at (6,-2) {};

\node[draw, fill = red!30, circle] (P111) at (0.25,-4) {};
\node[draw, fill = red!30, circle] (P112) at (1.5,-4) {};
\node[draw, fill = red!30, circle] (P113) at (2.75,-4) {};
\node[draw, fill = red!30, circle] (P114) at (3.3,-4) {};
\node[draw, fill = blue!30, circle] (P121) at (4,-4) {};
\node[draw, fill = red!30, circle] (P122) at (5.25,-4) {};
\node[draw, fill = red!30, circle] (P123) at (6.75,-4) {};

\node[draw, fill = red!30, circle] (P1111) at (0,-6) {};
\node[draw, fill = red!30, circle] (P1112) at (.5,-6) {};
\node[draw, fill = red!30, circle] (P1121) at (1,-6) {};
\node[draw, fill = red!30, circle] (P1122) at (1.5,-6) {};
\node[draw, fill = red!30, circle] (P1123) at (2,-6) {};
\node[draw, fill = red!30, circle] (P1131) at (2.5,-6) {};
\node[draw, fill = red!30, circle] (P1132) at (3,-6) {};
\node[draw, fill = blue!30, circle] (P1211) at (3.5,-6) {};
\node[draw, fill = blue!30, circle] (P1212) at (4,-6) {};
\node[draw, fill = red!30, circle] (P1213) at (4.5,-6) {};
\node[draw, fill = red!30, circle] (P1221) at (5,-6) {};
\node[draw, fill = red!30, circle] (P1222) at (5.5,-6) {};
\node[draw, fill = red!30, circle] (P1231) at (6,-6) {};
\node[draw, fill = red!30, circle] (P1232) at (6.5,-6) {};
\node[draw, fill = red!30, circle] (P1233) at (7,-6) {};
\node[draw, fill = red!30, circle] (P1234) at (7.5,-6) {};

\node at (-1,0) {$t=0$};
\node at (-1,-2) {$t=1$};
\node at (-1,-4) {$t=2$};
\node at (-1,-6) {$t=3$};

\draw (P1) -- (P11) -- (P111) -- (P1111);
\draw (P111) -- (P1112);
\draw (P11) -- (P112) -- (P1121);
\draw (P112) -- (P1122);
\draw (P112) -- (P1123);
\draw (P11) -- (P113) -- (P1131);
\draw (P113) -- (P1132);
\draw (P11) -- (P114);
\draw (P1) -- (P12) -- (P121);
\draw[blue] (P121) -- (P1211);
\draw[blue] (P121) -- (P1212);
\draw[blue] (P121) -- (P1213);
\draw[dashed] (P122) -- (P1213);
\draw (P12) -- (P122) -- (P1221);
\draw (P122) -- (P1222);
\draw (P12) -- (P123) -- (P1231);
\draw (P123) -- (P1232);
\draw (P123) -- (P1233);
\draw (P123) -- (P1234);
\end{tikzpicture}
```

-----

```{r,engine="tikz",echo=FALSE,fig.ext='svg'}
\begin{tikzpicture}
\node[draw, fill = red!30, circle,radius=.1] (I) at (0,0) {I};

\node[draw, fill = green!30, circle] (R) at (3,0) {R};
\draw[->] (I) -> node[above] {$\gamma$} (R);
\end{tikzpicture}
```
```{r,engine="tikz",echo=FALSE,fig.ext='svg'}
\begin{tikzpicture}
\node[draw, fill = blue!30, circle,radius=.1] (S) at (0,0) {S};
\node[draw, fill = red!30, circle,radius=.1] (I1) at (0,1) {I};
\node[draw, fill = red!30, circle] (I2) at (3,0) {I};
\draw[->] (S) -> node[above] {$\beta$} (I2);
\draw[dashed] (S) -- (I1) ;
\end{tikzpicture}
```



## Methods

Currently, we have two matrices controlling the transmission.  We have a transition matrix, and an interaction array.

#### Transition Matrix

 - $T$ is an $n \times n$ matrix, where $n$ is the number of states.
 - $T[i,j]$ is the probability of going from state $i$ to $j$.
 - $diag(T)$ is $0$.
 
#### Interaction Array
 - $I$ is an $n \times n \times n$ array, where $n$ is the number of states.
 - $I[i,j,k]$ is the probability $i$ meets $j$ and becomes $k$.
 - We can simplify this array into one or more matrices.

## Modeling assumptions

### Ideal Assumptions

   + The intervention cannot cause new infectious contacts
   + The intervention cannot prevent recovery
   
### Current Assumptions

   + An intervention cannot prevent state transition.
   + An intervention cannot introduce new interactions.
   + An intervention cannot transition to existing states except its initial state.

## Susceptible Depletion
 - Move susceptibles to other states (and back?)
 - Takes all current states and time
 
```{r,engine="tikz",echo=FALSE,fig.ext='svg'}
\begin{tikzpicture}
\node at (-1,0) {$t=0$};
\node at (-1,-1) {$t=1$};
\node at (-1,-2) {$t=2$};
\node at (-1,-3) {$t=3$};
\node[draw, fill = blue!30, circle,radius=.1] (S1) at (0,0) {$P_1^*$};
\node[draw, fill = yellow!60, circle,radius=.1] (S2) at (0,-1) {$P_1^*$};
\node[draw, fill = yellow!60, circle,radius=.1] (S3) at (0,-2) {$P_1^*$};
\node[draw, fill = blue!30, circle,radius=.1] (S4) at (0,-3) {$P_1^*$};

\node[draw, fill = blue!30, circle,radius=.1] (N1) at (4,0) {$P_1$};
\node[draw, fill = blue!30, circle,radius=.1] (N2) at (4,-1) {$P_1$};
\node[draw, fill = red!30, circle,radius=.1] (N3) at (4,-2) {$P_1$};
\node[draw, fill = red!30, circle,radius=.1] (N4) at (4,-3) {$P_1$};

\node[draw, fill = red!30, circle,radius=.1] (I1) at (2,0) {$P_2$};
\node[draw, fill = red!30, circle,radius=.1] (I2) at (2,-1) {$P_2$};
\node[draw, fill = green!30, circle,radius=.1] (I3) at (2,-2) {$P_2$};
\node[draw, fill = green!30, circle,radius=.1] (I4) at (2,-3) {$P_2$};
\draw[dashed] (S2) -- (I2) -- (N2) ;
\end{tikzpicture}
```

## Reduced Transmission
 - Prevent interactions that would otherwise occur.
 - Takes in the people their current states.
 
```{r,engine="tikz",echo=FALSE,fig.ext='svg'}
\begin{tikzpicture}
\node at (-1,0) {$t=0$};
\node at (-1,-1) {$t=1$};
\node at (-1,-2) {$t=2$};
\node at (-1,-3) {$t=3$};
\node[draw, fill = blue!30, circle,radius=.1] (S1) at (0,0) {$P_1^*$};
\node[draw, fill = blue!30, circle,radius=.1] (S2) at (0,-1) {$P_1^*$};
\node[draw, fill = blue!30, circle,radius=.1] (S3) at (0,-2) {$P_1^*$};
\node[draw, fill = blue!30, circle,radius=.1] (S4) at (0,-3) {$P_1^*$};

\node[draw, fill = blue!30, circle,radius=.1] (N1) at (4,0) {$P_1$};
\node[draw, fill = blue!30, circle,radius=.1] (N2) at (4,-1) {$P_1$};
\node[draw, fill = red!30, circle,radius=.1] (N3) at (4,-2) {$P_1$};
\node[draw, fill = red!30, circle,radius=.1] (N4) at (4,-3) {$P_1$};

\node[draw, fill = red!30, circle,radius=.1] (I1) at (2,0) {$P_2$};
\node[draw, fill = red!30, circle,radius=.1] (I2) at (2,-1) {$P_2$};
\node[draw, fill = green!30, circle,radius=.1] (I3) at (2,-2) {$P_2$};
\node[draw, fill = green!30, circle,radius=.1] (I4) at (2,-3) {$P_2$};
\draw[dashed,blue] (S2) -- (I2);
\draw[dashed] (I2) -- (N2) ;
\end{tikzpicture}
```

## Limitations
 - Fixed Population Only
 - For a population of $4$ million, and $\beta=\frac{.4}{\text{population}}$, it saves 4 GB of files per trial.
 - No good framework for a ``general'' intervention.
 - Modeling Assumptions not ideal
 